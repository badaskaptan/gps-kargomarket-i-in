import 'react-native-url-polyfill/auto';
import 'react-native-get-random-values';
import React, { useEffect, useState } from 'react';
import {
  SafeAreaView,
  Text,
  Button,
  Alert,
  ActivityIndicator,
  FlatList,
  View,
  TextInput,
} from 'react-native';
import * as Location from 'expo-location';
import * as TaskManager from 'expo-task-manager';
import { createClient } from '@supabase/supabase-js';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { NavigationContainer } from '@react-navigation/native';

// TEMP: react-native-web "props.pointerEvents is deprecated. Use style.pointerEvents" uyarƒ±sƒ±nƒ±
// √º√ß√ºnc√º parti bile≈üen (navigasyon / gesture) tetikliyor. Kodumuzda pointerEvents prop'u yok.
// Ge√ßici olarak bu spesifik uyarƒ±yƒ± bastƒ±rƒ±yoruz; kalƒ±cƒ± √ß√∂z√ºm: ilgili paket g√ºncellendiƒüinde kaldƒ±r.
if (typeof console !== 'undefined') {
  const origWarn = console.warn;
  console.warn = (...args: any[]) => {
    if (typeof args[0] === 'string' && args[0].includes('props.pointerEvents is deprecated')) return;
    origWarn(...args);
  };
}

// ‚úÖ ≈ûof√∂r sadece GPS Backend'ine baƒülƒ± (Sƒ∞Zƒ∞N BACKEND)
// iawqwfbvbigtbvipddao - Sizin GPS tracking backend'iniz
const SUPABASE_URL = 'https://iawqwfbvbigtbvipddao.supabase.co';
// Sizin GPS backend anon key
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlhd3F3ZmJ2YmlndGJ2aXBkZGFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MDczNzgsImV4cCI6MjA3MDQ4MzM3OH0._ogKEgwB53m-BrIxVjxi9xfOCZ3JyWvix2MPHNaOdrg';

// Bridge API endpoint'leri (Edge Functions)
// üåâ Bridge API URL (Sizin GPS Backend Edge Functions)
// ƒ∞steƒüe baƒülƒ±: Bridge API (≈üimdilik gerek yok, direkt tablo yazƒ±yoruz)
const BRIDGE_API_URL = 'https://iawqwfbvbigtbvipddao.supabase.co/functions/v1/bridge-api'

// üîÑ KARGOMARKETING BACKEND (Real-time sync i√ßin)
const KARGOMARKETING_URL = 'https://rmqwrdeaecjyyalbnvbq.supabase.co';
const KARGOMARKETING_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtcXdyZGVhZWNqeXlhbGJudmJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4MzM3MzUsImV4cCI6MjA2NzQwOTczNX0.L4vYHbdMKHaSw_NrMTcAwEPjs2MI-OqH6BeFtbSVHy0';

// ‚úÖ TEK BACKEND: Sadece GPS sistemi  
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    storage: AsyncStorage as any,
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: false,
  },
  // Realtime kapatma: herhangi bir channel a√ßmayacaƒüƒ±z. (Supabase-js v2'de direkt disable flag yok)
});

// üîÑ KARGOMARKETING CLIENT (Real-time sync i√ßin)
const kargoClient = createClient(KARGOMARKETING_URL, KARGOMARKETING_KEY);

// üë§ ≈ûOF√ñR ƒ∞Sƒ∞M/EMAIL E≈ûLE≈ûTƒ∞RME Sƒ∞STEMƒ∞
async function matchDriverByNameOrEmail(driverText: string, currentUserId: string): Promise<boolean> {
  try {
    console.log(`üë§ ≈ûof√∂r e≈üle≈ütirme: "${driverText}" ile "${currentUserId}" kontrol ediliyor`);
    
    // Mevcut kullanƒ±cƒ±nƒ±n bilgilerini al
    const { data: authData } = await supabase.auth.getUser();
    const user = authData?.user;
    
    if (!user) {
      console.log('‚ùå Kullanƒ±cƒ± oturumu bulunamadƒ±');
      return false;
    }
    
    // Kullanƒ±cƒ±nƒ±n isim ve email bilgileri
    const userFullName = user.user_metadata?.full_name || '';
    const userEmail = user.email || '';
    const userNameFromEmail = userEmail.split('@')[0] || '';
    
    // B√ºy√ºk/k√º√ß√ºk harf duyarlƒ±lƒ±ƒüƒ± olmadan kar≈üƒ±la≈ütƒ±r
    const searchText = driverText.toLowerCase().trim();
    const fullNameMatch = userFullName.toLowerCase().includes(searchText);
    const emailMatch = userEmail.toLowerCase().includes(searchText);
    const nameFromEmailMatch = userNameFromEmail.toLowerCase().includes(searchText);
    
    console.log(`üîç E≈üle≈ütirme kontrolleri:`);
    console.log(`   Aranan: "${searchText}"`);
    console.log(`   Full name: "${userFullName}" -> ${fullNameMatch}`);
    console.log(`   Email: "${userEmail}" -> ${emailMatch}`);
    console.log(`   Name from email: "${userNameFromEmail}" -> ${nameFromEmailMatch}`);
    
    const isMatch = fullNameMatch || emailMatch || nameFromEmailMatch;
    console.log(`‚úÖ E≈üle≈ütirme sonucu: ${isMatch}`);
    
    return isMatch;
  } catch (error) {
    console.error('‚ùå ≈ûof√∂r e≈üle≈ütirme hatasƒ±:', error);
    return false;
  }
}

// üåâ Kargomarketing'e real-time sync
async function syncToKargomarketing(updateData: any, ilan_no?: string) {
  try {
    console.log(`üåâ Kargomarketing sync ba≈ülƒ±yor:`, updateData);

    // ƒ∞lan numarasƒ±nƒ± belirle
    const targetIlanNo = ilan_no || updateData.ilan_no;
    if (!targetIlanNo) {
      console.log('‚ùå ƒ∞lan numarasƒ± bulunamadƒ±');
      return;
    }

    // Status color mapping tanƒ±mla - YENƒ∞ Frontend Enum Deƒüerleri + Legacy Support
    const statusColorMap: { [key: string]: string } = {
      'atanmamis': '#F59E0B',    // üü° Sarƒ± - ≈ûof√∂r Bekleniyor
      'atanmis': '#3B82F6',      // üîµ Mavi - ≈ûof√∂r Atandƒ±
      'basladi': '#10B981',      // üü¢ Ye≈üil - Sefer Ba≈üladƒ±
      'yolda': '#8B5CF6',        // üü£ Mor - Yolda
      'teslim_edildi': '#10B981', // üü¢ Ye≈üil - Teslim Edildi
      'tamamlandi': '#059669',   // üü¢ Emerald - Tamamlandƒ± (yeni format)
      'tamamlandƒ±': '#059669',   // üü¢ Emerald - Tamamlandƒ± (eski format - legacy support)
      'iptal_edildi': '#EF4444'  // üî¥ Kƒ±rmƒ±zƒ± - ƒ∞ptal Edildi
    };

    // Status label mapping
    const statusLabelMap: { [key: string]: string } = {
      'atanmamis': '≈ûof√∂r Bekleniyor',
      'atanmis': '≈ûof√∂r Atandƒ±',
      'basladi': 'Sefer Ba≈üladƒ±',
      'yolda': 'Yolda',
      'teslim_edildi': 'Teslim Edildi',
      'tamamlandi': 'Tamamlandƒ±',
      'iptal_edildi': 'ƒ∞ptal Edildi',
      // Eski GPS durumlarƒ±
      'beklemede': 'Beklemede',
      'devam_ediyor': 'Devam Ediyor',
      'tamamlandƒ±': 'Tamamlandƒ±'
    };

    // Progress mapping
    const progressMap: { [key: string]: number } = {
      'atanmamis': 0,         // ≈ûof√∂r Bekleniyor
      'atanmis': 20,          // ≈ûof√∂r Atandƒ±
      'basladi': 40,          // Sefer Ba≈üladƒ±
      'yolda': 70,            // Yolda
      'teslim_edildi': 90,    // Teslim Edildi
      'tamamlandi': 100,      // Tamamlandƒ±
      'iptal_edildi': 0,      // ƒ∞ptal Edildi
      // Eski GPS durumlarƒ±
      'beklemede': 25,
      'devam_ediyor': 75,
      'tamamlandƒ±': 100
    };

    // GPS durumlarƒ±nƒ± YENƒ∞ Kargomarketing frontend enum'larƒ±na mapple + Legacy Support
    const durumMapping: { [key: string]: string } = {
      'atanmamis': 'atanmamis',         // GPS atanmamƒ±≈ü ‚Üí Kargomarketing atanmamis
      'atanmis': 'atanmis',             // GPS atanmƒ±≈ü ‚Üí Kargomarketing atanmis
      'beklemede': 'atanmis',           // GPS beklemede ‚Üí Kargomarketing atanmis (≈ûof√∂r Atandƒ±)
      'basladi': 'basladi',             // GPS ba≈üladƒ± ‚Üí Kargomarketing basladi
      'devam_ediyor': 'yolda',          // GPS devam ediyor ‚Üí Kargomarketing yolda
      'yolda': 'yolda',                 // GPS yolda ‚Üí Kargomarketing yolda
      'teslim_edildi': 'teslim_edildi', // GPS teslim edildi ‚Üí Kargomarketing teslim_edildi
      'tamamlandi': 'tamamlandi',       // GPS tamamlandƒ± ‚Üí Kargomarketing tamamlandi (yeni format)
      'tamamlandƒ±': 'tamamlandi',       // GPS tamamlandƒ± ‚Üí Kargomarketing tamamlandi (eski format handle)
      'iptal_edildi': 'iptal_edildi'    // GPS iptal ‚Üí Kargomarketing iptal_edildi
    };

    // Update data'yƒ± kargomarketing i√ßin uyarla
    const kargoUpdateData = { ...updateData };
    if (kargoUpdateData.sefer_durumu) {
      // Mapping'den yeni durumu al, yoksa g√ºvenli default kullan
      const mappedStatus = durumMapping[kargoUpdateData.sefer_durumu] || 'atanmamis';
      kargoUpdateData.sefer_durumu = mappedStatus;

      if (!durumMapping[updateData.sefer_durumu]) {
        console.log(`‚ö†Ô∏è  Bilinmeyen durum: ${updateData.sefer_durumu} -> atanmamis (default)`);
      }
    }

    // ≈ûof√∂r ID'sini JSON bilgiye d√∂n√º≈üt√ºr ve driver_notes'a kaydet
    if (updateData.sofor_id) {
      // Auth session'dan ≈üof√∂r bilgilerini al
      const session = await supabase.auth.getSession();
      const user = session.data.session?.user;

      if (user) {
        // Dashboard uyumlu basit format
        const driverInfo = {
          name: user.user_metadata?.full_name || user.email?.split('@')[0] || '≈ûof√∂r',
          phone: user.phone || '',
          email: user.email || ''
        };

        // sofor_id'yi kaldƒ±r ve driver_notes'a basit JSON olarak ekle
        delete kargoUpdateData.sofor_id;
        kargoUpdateData.driver_notes = JSON.stringify(driverInfo);
        console.log(`üë§ ≈ûof√∂r bilgisi JSON: ${driverInfo.name} (${driverInfo.email})`);
      } else {
        delete kargoUpdateData.sofor_id;
        console.log('‚ö†Ô∏è  ≈ûof√∂r oturumu bulunamadƒ±, ID kaldƒ±rƒ±ldƒ±');
      }
    } else {
      // sofor_id null ise driver_notes'u da temizle
      if ('sofor_id' in updateData) {
        kargoUpdateData.driver_notes = null;
        delete kargoUpdateData.sofor_id;
      }
    }

    // GPS'ten tam veriyi al (zamanlama ve konum i√ßin)
    const { data: fullGpsData, error: gpsError } = await supabase
      .from('gorevler')
      .select('*')
      .eq('ilan_no', targetIlanNo)
      .single();

    if (!gpsError && fullGpsData) {
      // Diƒüer √∂nemli alanlarƒ± da ekle
      if (fullGpsData.baslama_zamani && !kargoUpdateData.baslama_zamani) {
        kargoUpdateData.baslama_zamani = fullGpsData.baslama_zamani;
      }
      if (fullGpsData.bitis_zamani && !kargoUpdateData.bitis_zamani) {
        kargoUpdateData.bitis_zamani = fullGpsData.bitis_zamani;
      }

      // customer_info'ya GPS metadata ekle
      if (fullGpsData.customer_info) {
        try {
          let customerObj;
          if (typeof fullGpsData.customer_info === 'string' && fullGpsData.customer_info.startsWith('{')) {
            customerObj = JSON.parse(fullGpsData.customer_info);
          } else {
            customerObj = { name: fullGpsData.customer_info };
          }

          // GPS i√ßin color ve metadata bilgisi ekle
          customerObj.status_color = statusColorMap[kargoUpdateData.sefer_durumu] || statusColorMap['atanmamis'];
          customerObj.status_label = statusLabelMap[kargoUpdateData.sefer_durumu] || 'Bilinmeyen';
          customerObj.progress_percentage = progressMap[kargoUpdateData.sefer_durumu] || 0;
          customerObj.sefer_durumu = kargoUpdateData.sefer_durumu;

          // GPS customer_info'yu g√ºncelle
          kargoUpdateData.customer_info = JSON.stringify(customerObj);
        } catch (e: any) {
          console.log(`‚ö†Ô∏è  customer_info JSON parse hatasƒ±: ${e.message}`);
        }
      }
    }

    // Kargomarketing'de mevcut veri var mƒ± kontrol et
    const { data: existing, error: checkError } = await kargoClient
      .from('gorevler')
      .select('*')
      .eq('ilan_no', targetIlanNo)
      .single();

    if (checkError && checkError.code !== 'PGRST116') {
      console.error('Kargomarketing kontrol hatasƒ±:', checkError);
      return;
    }

    if (existing) {
      console.log(`üìä Kargomarketing mevcut ≈üof√∂r bilgisi: ${existing.driver_notes || 'yok'}`);
      console.log(`üìä G√∂nderilecek ≈üof√∂r bilgisi: ${kargoUpdateData.driver_notes || 'yok'}`);

      // Constraint uyumluluƒüu kontrol et ve d√ºzelt
      if (kargoUpdateData.sefer_durumu !== 'tamamlandƒ±' && kargoUpdateData.bitis_zamani) {
        console.log(`‚ö†Ô∏è  Constraint uyarƒ±sƒ±: ${targetIlanNo} durumu ${kargoUpdateData.sefer_durumu} ama bitis_zamani var`);
        kargoUpdateData.bitis_zamani = null; // Constraint kuralƒ± gereƒüi null yap
      }

      // Eksik alanlarƒ± ekle (dashboard i√ßin gerekli)
      if (!kargoUpdateData.ilan_id) {
        kargoUpdateData.ilan_id = targetIlanNo;
      }
      if (!kargoUpdateData.customer_id) {
        kargoUpdateData.customer_id = null;
      }
      if (!kargoUpdateData.offer_id) {
        kargoUpdateData.offer_id = null;
      }

      // Dashboard metadata sadece GPS i√ßin (customer_info i√ßinde sakla)
      const gpsMetadata = {
        status_color: statusColorMap[kargoUpdateData.sefer_durumu] || statusColorMap['atanmamis'],
        status_label: statusLabelMap[kargoUpdateData.sefer_durumu] || 'Bilinmeyen',
        progress_percentage: progressMap[kargoUpdateData.sefer_durumu] || 0
      };

      console.log(`üé® Dashboard metadata: ${gpsMetadata.status_label} (${gpsMetadata.status_color})`);

      // Kargomarketing'e SADECE temel alanlarƒ± g√∂nder (progress_percentage, status_color, status_label HARƒ∞√á)
      const kargoSafeData = {
        sefer_durumu: kargoUpdateData.sefer_durumu,
        konum_verisi: kargoUpdateData.konum_verisi,
        driver_notes: kargoUpdateData.driver_notes,
        delivery_address: kargoUpdateData.delivery_address,
        updated_at: new Date().toISOString()
      };

      // Mevcut veriyi g√ºncelle
      const { error: updateError } = await kargoClient
        .from('gorevler')
        .update(kargoSafeData)
        .eq('ilan_no', targetIlanNo);

      if (updateError) {
        console.error('Kargomarketing g√ºncelleme hatasƒ±:', updateError);
      } else {
        console.log(`‚úÖ ${targetIlanNo} kargomarketing'de g√ºncellendi`);
        console.log(`   üìä Durum: ${kargoSafeData.sefer_durumu}`);
        const driverJson = kargoSafeData.driver_notes ? JSON.parse(kargoSafeData.driver_notes) : null;
        console.log(`   üë§ ≈ûof√∂r: ${driverJson ? driverJson.name : 'atanmamƒ±≈ü'}`);
        console.log(`   üìç Konum: ${kargoSafeData.konum_verisi ? 'g√ºncellendi' : 'deƒüi≈ümedi'}`);
      }
    } else {
      console.log(`‚ö†Ô∏è  ${targetIlanNo} kargomarketing'de bulunamadƒ±`);
    }
  } catch (error) {
    console.error('Kargomarketing sync hatasƒ±:', error);
  }
}

// NOT: Service role key kaldƒ±rƒ±ldƒ±. 401 hatasƒ± muhtemelen yanlƒ±≈ü / eski key y√ºz√ºnden.
// Supabase JS client + anon key ve RLS politikalarƒ± ile √ßalƒ±≈üƒ±yoruz.
async function selectIlanAtanmamis(ilanNo: string) {
  const { data, error } = await supabase
    .from('gorevler')
    .select('*')
    .eq('ilan_no', ilanNo)
    .eq('sefer_durumu', 'atanmamis')
    .limit(1);
  if (error) throw error;
  return data?.[0];
}

async function selectIlanAny(ilanNo: string) {
  const { data, error } = await supabase
    .from('gorevler')
    .select('*')
    .eq('ilan_no', ilanNo)
    .limit(1);
  if (error) throw error;
  return data?.[0];
}

async function updateGorev(rowId: string, patch: any) {
  const { data, error } = await supabase
    .from('gorevler')
    .update(patch)
    .eq('id', rowId)
    .select();
  if (error) throw error;

  const updatedGorev = data?.[0];

  // üîÑ Kargomarketing'e real-time sync
  if (updatedGorev && updatedGorev.ilan_no) {
    await syncToKargomarketing(patch, updatedGorev.ilan_no);
  }

  return updatedGorev;
}

const BG_TASK = 'gps_location_task';

// Arka plan task (mobil) ‚Äì basitle≈ütirilmi≈ü doƒürudan tablo g√ºncellemesi
TaskManager.defineTask(BG_TASK, async ({ data, error }) => {
  if (error) return;
  const { locations } = data as any;
  const loc = locations?.[0];
  if (!loc) return;
  const { latitude, longitude, speed, accuracy, heading, timestamp } = loc.coords;
  try {
    // Aktif g√∂rev: sefer_durumu 'devam_ediyor' olan ve mevcut ≈üof√∂re ait ilk satƒ±r
    const { data: authData, error: authErr } = await supabase.auth.getUser();
    if (authErr) return;
    const uid = authData?.user?.id;
    if (!uid) return;

    const { data: aktif } = await supabase
      .from('gorevler')
      .select('id')
      .eq('sefer_durumu', 'devam_ediyor')
      .eq('sofor_id', uid)
      .limit(1);
    const g = aktif?.[0];
    if (!g) return;
    await supabase
      .from('gorevler')
      .update({
        konum_verisi: {
          lat: latitude,
          lon: longitude,
          speed,
          accuracy,
          bearing: heading,
          ts: new Date(timestamp).toISOString(),
        },
        updated_at: new Date().toISOString(),
      })
      .eq('id', g.id);
  } catch { }
});

function AuthScreen({ setSession }: { setSession: (session: any) => void }) {
  const [email, setEmail] = React.useState('test@test.com');
  const [password, setPassword] = React.useState('test123');
  const [loading, setLoading] = React.useState(false);
  const [error, setError] = React.useState<string | null>(null);

  const signIn = async () => {
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) throw error;
      // onAuthStateChange listener already updates session
      Alert.alert('Giri≈ü ba≈üarƒ±lƒ±', `Kullanƒ±cƒ±: ${data.user?.email}`);
    } catch (e: any) {
      setError(e?.message || 'Giri≈ü ba≈üarƒ±sƒ±z');
      Alert.alert('Giri≈ü ba≈üarƒ±sƒ±z', e?.message || '');
    } finally {
      setLoading(false);
    }
  };

  const signUp = async () => {
    setLoading(true);
    setError(null);
    try {
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) throw error;
      Alert.alert('Kayƒ±t ba≈üarƒ±lƒ±', `Kullanƒ±cƒ± olu≈üturuldu: ${data.user?.email}. ≈ûimdi giri≈ü yapabilirsiniz.`);
    } catch (e: any) {
      setError(e?.message || 'Kayƒ±t ba≈üarƒ±sƒ±z');
      Alert.alert('Kayƒ±t ba≈üarƒ±sƒ±z', e?.message || '');
    } finally {
      setLoading(false);
    }
  };

  return (
    <SafeAreaView style={{ flex: 1, padding: 16 }}>
      <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 20 }}>GPS Sefer Takip</Text>
      <Text style={{ fontSize: 16, marginBottom: 10 }}>Email:</Text>
      <TextInput value={email} onChangeText={setEmail} autoCapitalize="none" keyboardType="email-address" style={{ padding: 8, backgroundColor: '#f0f0f0', marginBottom: 10 }} />
      <Text style={{ fontSize: 16, marginBottom: 10 }}>≈ûifre:</Text>
      <TextInput value={password} onChangeText={setPassword} secureTextEntry style={{ padding: 8, backgroundColor: '#f0f0f0', marginBottom: 20 }} />
      <Button title={loading ? "Giri≈ü yapƒ±lƒ±yor..." : "Giri≈ü Yap"} onPress={signIn} disabled={loading} />
      <Button title={loading ? "Kayƒ±t olu≈üturuluyor..." : "Kayƒ±t Ol"} onPress={signUp} disabled={loading} />
      {!!error && <Text style={{ color: 'red', marginTop: 8 }}>{error}</Text>}
      <Text style={{ marginTop: 16, color: '#666', fontSize: 12 }}>
        ƒ∞lk kez kullanƒ±yorsanƒ±z "Kayƒ±t Ol" butonuna basƒ±n.
      </Text>
    </SafeAreaView>
  );
}

function TasksScreen() {
  const [loading, setLoading] = useState(true);
  const [tasks, setTasks] = useState<any[]>([]);
  const [showConnectModal, setShowConnectModal] = useState(false);
  const [ilanNo, setIlanNo] = useState('');
  const [connecting, setConnecting] = useState(false);
  const [lastInfo, setLastInfo] = useState<string>('');
  const [userId, setUserId] = useState<string | null>(null);
  const [syncStatus, setSyncStatus] = useState<string>('Bekleniyor...');

  useEffect(() => {
    (async () => {
      const { data } = await supabase.auth.getUser();
      setUserId(data.user?.id || null);
    })();
  }, []);

    // üîÑ OTOMATIK SENKRONƒ∞ZASYON Sƒ∞STEMƒ∞ V2 - GPS AGENT OPTIMIZED
  useEffect(() => {
    console.log('üöÄ GPS Agent V2 - Smart Sync ba≈ülatƒ±lƒ±yor');

    let currentInterval = 15000; // Ba≈ülangƒ±√ß
    let noChangeCount = 0;
    let syncTimeoutId: NodeJS.Timeout;

    // Smart interval calculation
    const getNextInterval = (hasChanges: boolean) => {
      if (hasChanges) {
        noChangeCount = 0;
        return Math.max(5000, currentInterval * 0.8); // Speed up
      } else {
        noChangeCount++;
        if (noChangeCount < 3) return currentInterval;
        if (noChangeCount < 6) return Math.min(60000, currentInterval * 1.5);
        return Math.min(120000, currentInterval * 2); // Max 2 min
      }
    };

    // Optimized sync function
    const smartSync = async (): Promise<boolean> => {
      let hasChanges = false;
      
      try {
        setSyncStatus('üöÄ Smart sync √ßalƒ±≈üƒ±yor...');
        
        const { data: newKargoTasks, error: kargoError } = await kargoClient
          .from('gorevler')
          .select('*')
          .eq('sefer_durumu', 'atanmamis')
          .is('sofor_id', null)
          .order('created_at', { ascending: false })
          .limit(10);

        if (kargoError) {
          setSyncStatus('‚ùå Sync hatasƒ±: ' + kargoError.message);
          return hasChanges;
        }

        if (newKargoTasks && newKargoTasks.length > 0) {
          setSyncStatus(`üì¶ ${newKargoTasks.length} yeni g√∂rev bulundu`);
          hasChanges = true;
          
          for (const kargoTask of newKargoTasks) {
            try {
              const { data: existingGpsTask } = await supabase
                .from('gorevler')
                .select('id')
                .eq('ilan_no', kargoTask.ilan_no)
                .single();

              if (!existingGpsTask) {
                let assignedDriverText = null;
                
                if (kargoTask.driver_notes) {
                  try {
                    const driverInfo = JSON.parse(kargoTask.driver_notes);
                    assignedDriverText = driverInfo.name || driverInfo.email;
                  } catch (e) {
                    assignedDriverText = kargoTask.driver_notes;
                  }
                }

                const newGpsTask = {
                  ilan_no: kargoTask.ilan_no,
                  customer_info: kargoTask.customer_info || kargoTask.musteri_bilgileri,
                  delivery_address: kargoTask.delivery_address || kargoTask.teslimat_adresi,
                  sefer_durumu: 'atanmamis',
                  created_at: new Date().toISOString(),
                  updated_at: new Date().toISOString(),
                  arsivli: false,
                  sofor_id: null
                };

                const { error: insertError } = await supabase
                  .from('gorevler')
                  .insert([newGpsTask]);

                if (!insertError) {
                  console.log(`‚úÖ Smart sync: ${kargoTask.ilan_no} kopyalandƒ±`);
                  
                  if (assignedDriverText && userId) {
                    const isDriverMatch = await matchDriverByNameOrEmail(assignedDriverText, userId);
                    if (isDriverMatch) {
                      const { data: insertedTask } = await supabase
                        .from('gorevler')
                        .select('id')
                        .eq('ilan_no', kargoTask.ilan_no)
                        .single();
                        
                      if (insertedTask) {
                        await updateGorev(insertedTask.id, { 
                          sofor_id: userId, 
                          sefer_durumu: 'beklemede',
                          updated_at: new Date().toISOString() 
                        });
                        console.log(`üéØ Auto assigned: ${kargoTask.ilan_no} -> ${assignedDriverText}`);
                        setSyncStatus(`üéØ ${kargoTask.ilan_no} size atandƒ±!`);
                      }
                    }
                  }
                }
              }
            } catch (e) {
              console.log('Sync error:', e);
            }
          }

          load();
        } else {
          setSyncStatus('‚úÖ Smart sync tamam - yeni g√∂rev yok');
        }
        
      } catch (error) {
        console.log('Smart sync hatasƒ±:', error);
        setSyncStatus('‚ùå Smart sync hatasƒ±');
      }
      
      return hasChanges;
    };

    // Smart polling loop
    const startPolling = () => {
      const poll = async () => {
        const changes = await smartSync();
        currentInterval = getNextInterval(changes);
        
        console.log(`‚è±Ô∏è  Next poll in ${currentInterval/1000}s (changes: ${changes})`);
        syncTimeoutId = setTimeout(poll, currentInterval);
      };
      
      poll(); // Start immediately
    };

    startPolling();

    return () => {
      if (syncTimeoutId) {
        clearTimeout(syncTimeoutId);
      }
    };
  }, []);

  useEffect(() => { if (userId) load(); }, [userId]);

  const load = async () => {
    setLoading(true);
    try {
      // Aktif g√∂revler (beklemede + devam_ediyor), ar≈üivli olmayanlar
      const { data: active, error: errActive } = await supabase
        .from('gorevler')
        .select('*')
        .eq('sofor_id', userId || '')
        .in('sefer_durumu', ['beklemede', 'devam_ediyor'])
        .eq('arsivli', false)
        .order('created_at', { ascending: false });

      if (errActive) throw errActive;

      // Son tamamlanan (yalnƒ±zca 1 tane), ar≈üivli olmayan
      const { data: lastDoneArr, error: errDone } = await supabase
        .from('gorevler')
        .select('*')
        .eq('sofor_id', userId || '')
        .eq('sefer_durumu', 'tamamlandƒ±')
        .eq('arsivli', false)
        .order('bitis_zamani', { ascending: false })
        .order('created_at', { ascending: false })
        .limit(1);

      if (errDone) throw errDone;

      const combined = [...(active ?? []), ...(lastDoneArr?.[0] ? [lastDoneArr[0]] : [])];
      setTasks(combined);
    } catch (e) {
      console.log('G√∂rev y√ºkleme hatasƒ±:', e);
    } finally {
      setLoading(false);
    }
  };

  // ‚úÖ DOƒûRU Mƒ∞MARƒ∞: Sadece kendi backend'inden ilan bul
  const connectToIlan = async () => {
    const notify = (title: string, msg?: string) => {
      const text = msg ? `${title}\n\n${msg}` : title;
      if (typeof window !== 'undefined') {
        window.alert(text);
      } else {
        Alert.alert(title, msg || '');
      }
      setLastInfo(text);
    };

    if (!ilanNo.trim()) {
      notify('Hata', 'ƒ∞lan numarasƒ± bo≈ü olamaz');
      return;
    }

    setConnecting(true);
    try {
      console.log('üîç ƒ∞lan aranƒ±yor:', ilanNo.trim());

      // ƒ∞lan numarasƒ±na g√∂re bo≈üta (atanmamƒ±≈ü) kayƒ±t ara
      let gpsTask: any = null;
      try {
        gpsTask = await selectIlanAtanmamis(ilanNo.trim());
      } catch (e) {
        console.log('Select ilan hatasƒ±:', e);
      }
      if (!gpsTask) {
        // Fallback: ilan var ama atanabilir durumda olmayabilir; mevcut durumunu g√∂sterelim
        let anyTask: any = null;
        try {
          anyTask = await selectIlanAny(ilanNo.trim());
        } catch (e) {
          console.log('Fallback ilan sorgu hatasƒ±:', e);
        }
        if (anyTask) {
          notify(
            'ƒ∞lan atanamaz durumda',
            `ƒ∞lan bulundu fakat durumu: ${anyTask.sefer_durumu}.\n\n` +
            `Atanabilir olmasƒ± i√ßin sefer_durumu = 'atanmamis' olmalƒ±.\n` +
            `Gerekiyorsa SQL ile g√ºncelleyin: UPDATE gorevler SET sefer_durumu='atanmamis' WHERE ilan_no='${ilanNo.trim()}';`
          );
        } else {
          notify(
            'ƒ∞lan Bulunamadƒ±',
            `ƒ∞lan numarasƒ± "${ilanNo}" GPS sisteminde bulunamadƒ±.\n\n` +
            'Bu ilan hen√ºz kargomarketing.com tarafƒ±ndan GPS sistemine g√∂nderilmemi≈ü olabilir.\n\n' +
            'Bridge sistemi √ßalƒ±≈üƒ±yor mu kontrol edin veya test i√ßin kayƒ±t ekleyin.'
          );
        }
        setConnecting(false);
        return;
      }

      console.log('‚úÖ ƒ∞lan bulundu:', gpsTask);

      // 3. ≈ûof√∂r√º g√∂reve ata (test user)
      try {
        if (!userId) throw new Error('Kullanƒ±cƒ± oturumu yok');
        await updateGorev(gpsTask.id, { sofor_id: userId, sefer_durumu: 'beklemede', updated_at: new Date().toISOString() });
      } catch (e: any) {
        notify('Atama Hatasƒ±', 'G√∂rev atamasƒ± yapƒ±lamadƒ±: ' + e.message);
        setConnecting(false);
        return;
      }

      // 4. Bridge API'ye bilgilendirme g√∂nder (Edge Function)
      console.log('G√∂rev atandƒ± (beklemede).');

      // 5. Ba≈üarƒ± mesajƒ±
      notify(
        'Baƒülantƒ± Ba≈üarƒ±lƒ±! ‚úÖ',
        `ƒ∞lan "${ilanNo}" ile baƒülantƒ± kuruldu.\n\n` +
        `M√º≈üteri: ${gpsTask.customer_info?.name || 'Bilgi yok'}\n` +
        `Telefon: ${gpsTask.customer_info?.phone || 'Bilgi yok'}\n\n` +
        'Artƒ±k GPS takibi ba≈ülatabilirsiniz!'
      );

      setShowConnectModal(false);
      setIlanNo('');
      load(); // G√∂rev listesini yenile

    } catch (error: any) {
      const msg = error?.message || 'GPS sistemi baƒülantƒ±sƒ± sƒ±rasƒ±nda hata olu≈ütu';
      const text = `Baƒülantƒ± Hatasƒ±\n\n${msg}`;
      if (typeof window !== 'undefined') window.alert(text); else Alert.alert('Baƒülantƒ± Hatasƒ±', msg);
      setLastInfo(text);
    }
    setConnecting(false);
  };

  useEffect(() => { if (userId) load(); }, [userId]);

  // ‚úÖ GPS verilerini Backend2'de depola, Bridge API ile Backend1'e anlƒ±k g√∂nder
  const sendLocationUpdate = async (taskId: string, location: any) => {
    try {
      await supabase
        .from('gorevler')
        .update({ konum_verisi: location, updated_at: new Date().toISOString() })
        .eq('id', taskId);
    } catch (e) { console.log('Konum g√ºncelleme hatasƒ±:', e); }
  };

  const startSefer = async (id: string) => {
    await updateGorev(id, { sefer_durumu: 'devam_ediyor', baslama_zamani: new Date().toISOString(), updated_at: new Date().toISOString() });
    await ensureTracking();
    load();
  };

  const stopSefer = async (id: string) => {
    // Web'de Alert.alert √ßalƒ±≈ümaz, confirm kullan
    if (typeof window !== 'undefined') {
      const confirmed = window.confirm(
        'Seferi sonlandƒ±rmak istediƒüinize emin misiniz?\n\nSefer manuel sonlandƒ±rƒ±ldƒ±ƒüƒ±nda yeni emir gelmeden tekrar ba≈ülatƒ±lamaz.'
      );
      if (confirmed) {
        try {
          console.log('Sefer sonlandƒ±rƒ±lƒ±yor:', id);
          await updateGorev(id, { sefer_durumu: 'tamamlandƒ±', bitis_zamani: new Date().toISOString(), updated_at: new Date().toISOString() });
          await stopTracking();
          load();
        } catch (error) {
          console.error('Sefer sonlandƒ±rma hatasƒ±:', error);
        }
      }
      return;
    }

    // Mobil platform i√ßin Alert
    Alert.alert(
      'Seferi Sonlandƒ±r',
      'Seferi sonlandƒ±rmak istediƒüinize emin misiniz? Sefer manuel sonlandƒ±rƒ±ldƒ±ƒüƒ±nda yeni emir gelmeden tekrar ba≈ülatƒ±lamaz.',
      [
        { text: 'ƒ∞ptal', style: 'cancel' },
        {
          text: 'Evet', style: 'destructive', onPress: async () => {
            await updateGorev(id, { sefer_durumu: 'tamamlandƒ±', bitis_zamani: new Date().toISOString(), updated_at: new Date().toISOString() });
            await stopTracking();
            load();
          }
        },
      ]
    );
  };

  const archiveTask = async (id: string) => {
    try {
      await updateGorev(id, { arsivli: true, updated_at: new Date().toISOString() });
      load();
    } catch (e) {
      console.log('Ar≈üivleme hatasƒ±:', e);
      Alert.alert('Ar≈üivleme Hatasƒ±', 'G√∂rev ar≈üivlenemedi');
    }
  };

  const ensureTracking = async () => {
    // Web'de TaskManager √ßalƒ±≈ümaz, basit konum takibi yapalƒ±m
    if (typeof window !== 'undefined') {
      // Web platformu
      if (!navigator.geolocation) {
        Alert.alert('Konum desteƒüi yok', 'Tarayƒ±cƒ±nƒ±z konum desteƒüi sunmuyor');
        return;
      }

      // Zaten bir interval √ßalƒ±≈üƒ±yorsa yenisini ba≈ülatma (√ßoƒüalmayƒ± engelle)
      if ((window as any).locationInterval) {
        console.log('Web konum takibi zaten aktif, yeni interval ba≈ülatƒ±lmƒ±yor');
        return;
      }

      // Konum izni iste
      try {
        const position = await new Promise<GeolocationPosition>((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });
        console.log('Web konum alƒ±ndƒ±:', position.coords);

        // Web'de 5 saniyede bir konum al (basit timer)
        const interval = setInterval(async () => {
          navigator.geolocation.getCurrentPosition(async (pos) => {
            const { latitude, longitude, speed, accuracy, heading } = pos.coords;
            try {
              const { data: activeArr, error: activeErr } = await supabase
                .from('gorevler')
                .select('id')
                .eq('sefer_durumu', 'devam_ediyor')
                .eq('sofor_id', userId || '')
                .limit(1);
              if (activeErr) throw activeErr;
              const g = activeArr?.[0];
              if (!g) {
                console.log('Aktif g√∂rev bulunamadƒ±, konum takibi durduruluyor');
                clearInterval(interval);
                (window as any).locationInterval = null;
                return;
              }

              console.log('Konum g√ºncelleniyor:', { g_id: g.id, lat: latitude, lon: longitude });
              const locationPayload = {
                lat: latitude,
                lon: longitude,
                speed,
                accuracy,
                bearing: heading,
                ts: new Date().toISOString(),
              };
              await updateGorev(g.id, { konum_verisi: locationPayload, updated_at: new Date().toISOString() });
              console.log('Konum g√∂nderildi:', locationPayload);
            } catch (err) {
              console.error('Konum g√∂nderme hatasƒ±:', err);
            }
          });
        }, 5000);

        // Global'e kaydet ki durdurabilelim
        (window as any).locationInterval = interval;

      } catch (error) {
        Alert.alert('Konum izni', 'Konum izni verilmedi');
      }
      return;
    }

    // Mobil platform (orijinal kod)
    const { granted } = await Location.requestForegroundPermissionsAsync();
    const bg = await Location.requestBackgroundPermissionsAsync();
    if (!granted || bg.status !== 'granted') { Alert.alert('Konum izni gerekli'); return; }
    const hasStarted = await TaskManager.isTaskRegisteredAsync(BG_TASK);
    const running = await Location.hasStartedLocationUpdatesAsync(BG_TASK);
    if (!hasStarted || !running) {
      await Location.startLocationUpdatesAsync(BG_TASK, {
        accuracy: Location.Accuracy.High,
        timeInterval: 5000,
        distanceInterval: 0,
        showsBackgroundLocationIndicator: true,
        pausesUpdatesAutomatically: false,
        foregroundService: {
          notificationTitle: 'Sefer Takibi A√ßƒ±k',
          notificationBody: 'Konumunuz arka planda g√ºncelleniyor',
        },
      });
    }
  };

  const stopTracking = async () => {
    // Web'de interval'i durdur
    if (typeof window !== 'undefined') {
      const interval = (window as any).locationInterval;
      if (interval) {
        clearInterval(interval);
        (window as any).locationInterval = null;
        console.log('Web konum takibi durduruldu');
      }
      return;
    }

    // Mobil platform
    const running = await Location.hasStartedLocationUpdatesAsync(BG_TASK);
    if (running) await Location.stopLocationUpdatesAsync(BG_TASK);
  };

  if (loading) return <ActivityIndicator style={{ marginTop: 50 }} /> as any;

  return (
    <SafeAreaView style={{ flex: 1, padding: 16 }}>
      {/* Otomatik Sync Durumu */}
      <View style={{ marginBottom: 12, backgroundColor: '#e8f5e8', padding: 10, borderRadius: 6 }}>
        <Text style={{ fontSize: 14, fontWeight: '600', color: '#2d5016' }}>üîÑ Otomatik Senkronizasyon</Text>
        <Text style={{ fontSize: 12, color: '#4a7c59', marginTop: 4 }}>{syncStatus}</Text>
      </View>

      {/* ƒ∞lan Baƒülantƒ± Butonu */}
      <View style={{ marginBottom: 16, backgroundColor: '#f8f9fa', padding: 12, borderRadius: 8 }}>
        <Text style={{ fontSize: 16, fontWeight: '600', marginBottom: 8 }}>üìã ƒ∞lan Baƒülantƒ±sƒ±</Text>
        <Text style={{ fontSize: 14, color: '#666', marginBottom: 8 }}>
          Kargomarketing.com'dan aldƒ±ƒüƒ±nƒ±z ilan numarasƒ± ile baƒülantƒ± kurun
        </Text>
        <Button
          title="ƒ∞lan No ile Baƒülan"
          onPress={() => setShowConnectModal(true)}
          color="#007AFF"
        />
        {!!lastInfo && (
          <Text style={{ marginTop: 10, color: '#495057' }}>{lastInfo}</Text>
        )}
      </View>

      {/* ƒ∞lan Baƒülantƒ± Modal */}
      {showConnectModal && (
        <View style={{
          position: 'absolute',
          top: 0, left: 0, right: 0, bottom: 0,
          backgroundColor: 'rgba(0,0,0,0.5)',
          justifyContent: 'center',
          alignItems: 'center',
          zIndex: 1000
        }}>
          <View style={{
            backgroundColor: 'white',
            padding: 20,
            borderRadius: 10,
            width: '80%',
            maxWidth: 400
          }}>
            <Text style={{ fontSize: 18, fontWeight: '600', marginBottom: 16 }}>
              üìã ƒ∞lan Numarasƒ± Girin
            </Text>
            <Text style={{ marginBottom: 12, color: '#666' }}>
              Kargomarketing.com'dan aldƒ±ƒüƒ±nƒ±z ilan numarasƒ±nƒ± girin:
            </Text>
            <TextInput
              value={ilanNo}
              onChangeText={setIlanNo}
              placeholder="√ñrn: KRG2025001"
              style={{
                padding: 12,
                borderWidth: 1,
                borderColor: '#ddd',
                borderRadius: 6,
                marginBottom: 16,
                fontSize: 16,
              }}
            />
            <View style={{ flexDirection: 'row', gap: 8 }}>
              <Button
                title="ƒ∞ptal"
                onPress={() => setShowConnectModal(false)}
                color="#6c757d"
              />
              <Button
                title={connecting ? 'Baƒülanƒ±yor...' : 'Baƒülan'}
                onPress={connectToIlan}
                disabled={connecting}
                color="#007AFF"
              />
            </View>
          </View>
        </View>
      )}

      {/* G√∂rev Listesi */}
      {tasks.length === 0 ? (
        <View style={{ padding: 20, alignItems: 'center' }}>
          <Text style={{ fontSize: 16, color: '#666' }}>
            Hen√ºz g√∂rev bulunmuyor
          </Text>
          <Text style={{ fontSize: 14, color: '#999', marginTop: 8, textAlign: 'center' }}>
            √ústteki "ƒ∞lan No ile Baƒülan" butonunu kullanarak yeni g√∂rev baƒülantƒ±sƒ± kurabilirsiniz
          </Text>
        </View>
      ) : (
        <FlatList
          data={tasks}
          keyExtractor={(item) => item.id}
          renderItem={({ item }) => (
            <View style={{ padding: 12, borderBottomWidth: 1, borderColor: '#eee', backgroundColor: '#fff', marginBottom: 8, borderRadius: 8 }}>
              <View style={{ flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>
                <Text style={{ fontWeight: '600', fontSize: 16 }}>üì¶ {item.ilan_no}</Text>
                <Text style={{
                  color: item.sefer_durumu === 'devam_ediyor' ? '#28a745' : item.sefer_durumu === 'beklemede' ? '#ffc107' : '#6c757d',
                  fontWeight: '500'
                }}>
                  {item.sefer_durumu}
                </Text>
              </View>

              {item.customer_info && (
                <Text style={{ color: '#666', marginBottom: 4 }}>
                  M√º≈üteri: {(() => {
                    try {
                      if (typeof item.customer_info === 'string') {
                        if (item.customer_info.startsWith('{')) {
                          const parsed = JSON.parse(item.customer_info);
                          return parsed.name || 'Belirtilmemi≈ü';
                        }
                        return item.customer_info;
                      }
                      return item.customer_info?.name || 'Belirtilmemi≈ü';
                    } catch (e) {
                      return item.customer_info;
                    }
                  })()}
                </Text>
              )}

              {item.delivery_address && (
                <Text style={{ color: '#666', marginBottom: 8 }}>
                  Adres: {(() => {
                    try {
                      if (typeof item.delivery_address === 'string') {
                        if (item.delivery_address.startsWith('{')) {
                          const parsed = JSON.parse(item.delivery_address);
                          return parsed.city || 'Belirtilmemi≈ü';
                        }
                        return item.delivery_address;
                      }
                      return item.delivery_address?.city || 'Belirtilmemi≈ü';
                    } catch (e) {
                      return item.delivery_address;
                    }
                  })()}
                </Text>
              )}

              <View style={{ flexDirection: 'row', gap: 8, marginTop: 8 }}>
                {item.sefer_durumu === 'beklemede' && (
                  <Button title="‚úÖ Sefer Ba≈ülat" onPress={() => startSefer(item.id)} color="#28a745" />
                )}
                {item.sefer_durumu !== 'tamamlandƒ±' && (
                  <Button title="üõë Seferi Sonlandƒ±r" color="#dc3545" onPress={() => stopSefer(item.id)} />
                )}
                {item.sefer_durumu === 'tamamlandƒ±' && (
                  <Button title="üì¶ Ar≈üivle" color="#6c757d" onPress={() => archiveTask(item.id)} />
                )}
              </View>
            </View>
          )}
        />
      )}

      <View style={{ height: 12 }} />
      <Button title="üîÑ Yenile" onPress={load} />
    </SafeAreaView>
  );
}

export default function App() {
  const [ready, setReady] = useState(false);
  const [session, setSession] = useState<any>(null);

  useEffect(() => {
    (async () => {
      const {
        data: { session },
      } = await supabase.auth.getSession();
      setSession(session);
      setReady(true);
      const { data: authListener } = supabase.auth.onAuthStateChange((_event, s) => {
        setSession(s);
      });
      return () => {
        authListener.subscription.unsubscribe();
      };
    })();
  }, []);

  if (!ready) return <ActivityIndicator style={{ marginTop: 50 }} /> as any;

  return (
    <NavigationContainer>
      {session ? <TasksScreen /> : <AuthScreen setSession={setSession} />}
    </NavigationContainer>
  );
}
