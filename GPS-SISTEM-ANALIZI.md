# üöÄ GPS TAKƒ∞P Sƒ∞STEMƒ∞ - DETAYLI ANALƒ∞Z

## üìä Sƒ∞STEM Mƒ∞MARƒ∞Sƒ∞ √ñZET

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ KargoMarketing  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ    gorevler      ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∂‚îÇ Mobile App      ‚îÇ    ‚îÇ  KargoMarketing  ‚îÇ
‚îÇ   Backend       ‚îÇ    ‚îÇ   (Ana Tablo)    ‚îÇ    ‚îÇ  (GPS ≈ûof√∂r)    ‚îÇ    ‚îÇ   Dashboard      ‚îÇ
‚îÇ (G√∂rev Olu≈ütur) ‚îÇ    ‚îÇ                  ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ (Canlƒ± Takip)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ                       ‚îÇ                       ‚ñ≤
                                ‚ñº                       ‚ñº                       ‚îÇ
                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
                       ‚îÇ     Trigger      ‚îÇ    ‚îÇ  gps_kayitlari  ‚îÇ              ‚îÇ
                       ‚îÇ  (Otomatik TC    ‚îÇ    ‚îÇ  (Ham GPS Data) ‚îÇ              ‚îÇ
                       ‚îÇ   E≈üle≈ütirme)    ‚îÇ    ‚îÇ                 ‚îÇ              ‚îÇ
                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
                                                       ‚îÇ                       ‚îÇ
                                                       ‚ñº                       ‚îÇ
                                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
                                              ‚îÇ   gps_tracking  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                              ‚îÇ (ƒ∞≈ülenmi≈ü GPS)  ‚îÇ
                                              ‚îÇ (KM Dashboard)  ‚îÇ
                                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìã TABLOLAR VE KOLON DETAYLARI

### 1Ô∏è‚É£ **gorevler** (Ana G√∂rev Tablosu)

**Kim Ne Zaman Veri Ekliyor:**
- **KargoMarketing Backend**: Yeni g√∂rev olu≈üturulduƒüunda
- **Trigger**: TC kimlik e≈üle≈ütirmesi sonrasƒ±
- **Mobile App**: ≈ûof√∂r kabul/red, sefer ba≈ülat/bitir

```sql
CREATE TABLE gorevler (
  -- KargoMarketing'den gelen veriler
  ilan_no VARCHAR(50) UNIQUE NOT NULL,           -- üìù KM: Benzersiz g√∂rev no
  tc_kimlik VARCHAR(11) NOT NULL,                -- üÜî KM: ≈ûof√∂r TC kimlik
  sofor_adi VARCHAR(100) NOT NULL,               -- üë§ KM: ≈ûof√∂r adƒ±
  musteri_bilgisi TEXT,                          -- üìã KM: M√º≈üteri detaylarƒ±
  teslimat_adresi TEXT NOT NULL,                 -- üìç KM: Teslimat adresi
  
  -- Trigger tarafƒ±ndan doldurulur
  sofor_id UUID REFERENCES auth.users(id),      -- üîó Trigger: E≈üle≈üen ≈üof√∂r ID
  durum VARCHAR(20) DEFAULT 'eslesme_bekleniyor', -- üìä Trigger: G√∂rev durumu
  
  -- Mobile App tarafƒ±ndan doldurulur
  kabul_edildi_mi BOOLEAN DEFAULT FALSE,         -- ‚úÖ Mobile: ≈ûof√∂r kabul√º
  sefer_durumu VARCHAR(20) DEFAULT 'beklemede',  -- üöõ Mobile: Sefer durumu
  baslangic_zamani TIMESTAMP,                    -- ‚è∞ Mobile: Sefer ba≈ülangƒ±√ß
  bitis_zamani TIMESTAMP,                        -- ‚è∞ Mobile: Sefer biti≈ü
  
  -- GPS Trigger tarafƒ±ndan g√ºncellenir  
  son_konum_lat DECIMAL(10,8),                   -- üìç GPS: Son latitude
  son_konum_lng DECIMAL(11,8),                   -- üìç GPS: Son longitude
);
```

**Veri Akƒ±≈üƒ±:**
1. **KargoMarketing** ‚Üí `ilan_no, tc_kimlik, sofor_adi, teslimat_adresi`
2. **Trigger** ‚Üí `sofor_id, durum` (TC e≈üle≈ütirme sonrasƒ±)
3. **Mobile App** ‚Üí `kabul_edildi_mi, sefer_durumu, baslangic_zamani, bitis_zamani`
4. **GPS Trigger** ‚Üí `son_konum_lat, son_konum_lng` (GPS'ten gelen son konum)

---

### 2Ô∏è‚É£ **gps_kayitlari** (Ham GPS Verileri)

**Kim Veri Ekliyor:** Sadece **Mobile App** (≈ûof√∂r telefonu)

```sql
CREATE TABLE gps_kayitlari (
  gorev_id UUID REFERENCES gorevler(id),         -- üîó Hangi g√∂reve ait
  sofor_id UUID REFERENCES auth.users(id),      -- üë§ Hangi ≈üof√∂r
  
  -- Ham GPS koordinatlarƒ± (Mobile App'den)
  latitude DECIMAL(10,8) NOT NULL,               -- üìç Enlem
  longitude DECIMAL(11,8) NOT NULL,              -- üìç Boylam  
  hiz DECIMAL(5,2) DEFAULT 0,                    -- üöó Hƒ±z (km/saat)
  yon INTEGER DEFAULT 0,                         -- üß≠ Y√∂n (0-360 derece)
  dogruluk DECIMAL(5,2) DEFAULT 0,               -- üéØ GPS doƒüruluk (metre)
  
  -- KargoMarketing i√ßin metadata (Mobile App'den)
  konum_verisi JSONB,                            -- üì± Device + GPS metadata
  
  timestamp TIMESTAMP DEFAULT NOW()              -- ‚è∞ Kayƒ±t zamanƒ±
);
```

**Mobile App'den Gelen `konum_verisi` JSONB ƒ∞√ßeriƒüi:**
```json
{
  "device_info": {
    "model": "Samsung Galaxy A54",              // üì± Telefon modeli
    "os": "Android 13",                         // ü§ñ ƒ∞≈ületim sistemi
    "app_version": "2.1.3",                     // üì¶ Uygulama versiyonu
    "battery_level": 85,                        // üîã Batarya seviyesi
    "signal_strength": 4                        // üì∂ Sinyal g√ºc√º
  },
  "gps_metadata": {
    "satellites": 8,                            // üõ∞Ô∏è Uydu sayƒ±sƒ±
    "hdop": 1.2,                               // üìê GPS doƒüruluk fakt√∂r√º
    "altitude": 45.5,                          // ‚õ∞Ô∏è Rakƒ±m
    "speed_accuracy": 0.5,                     // üéØ Hƒ±z doƒüruluƒüu
    "bearing_accuracy": 2.1                    // üß≠ Y√∂n doƒüruluƒüu
  },
  "timestamp_device": "2025-08-16T10:30:15Z",  // ‚è∞ Device timestamp
  "location_source": "GPS",                     // üì° Konum kaynaƒüƒ±
  "collection_method": "automatic"              // üîÑ Toplama y√∂ntemi
}
```

**Veri Sƒ±klƒ±ƒüƒ±:** Her 10 saniyede bir (Mobile App tarafƒ±ndan)

---

### 3Ô∏è‚É£ **gps_tracking** (KargoMarketing Dashboard)

**Kim Veri Ekliyor:** **Trigger** (gps_kayitlari'ndan otomatik)

```sql
CREATE TABLE gps_tracking (
  id BIGSERIAL NOT NULL,                        -- üî¢ Auto increment ID
  gorev_id UUID UNIQUE,                         -- üîó G√∂rev ID (Benzersiz!)
  
  -- ƒ∞≈ülenmi≈ü GPS verileri (Trigger'dan)
  latitude NUMERIC(10, 8) NOT NULL,             -- üìç Son enlem
  longitude NUMERIC(11, 8) NOT NULL,            -- üìç Son boylam
  hiz INTEGER NULL,                             -- üöó Son hƒ±z
  yon INTEGER NULL,                             -- üß≠ Son y√∂n
  dogruluk INTEGER NULL,                        -- üéØ Son doƒüruluk
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- ‚è∞ ƒ∞lk kayƒ±t
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP  -- ‚è∞ Son g√ºncelleme
);
```

**√ñnemli:** 
- Bu tablo **UNIQUE (gorev_id)** constraint'i var
- Her g√∂rev i√ßin **tek kayƒ±t** tutulur
- **UPSERT** ile s√ºrekli g√ºncellenir
- KargoMarketing Dashboard buradan **canlƒ± takip** yapar

---

## üîÑ VERƒ∞ AKI≈ûI DETAYlarƒ±

### üì± Mobile App GPS Fonksiyonu (`sendGPSData`)

```typescript
const sendGPSData = async (location, taskId, userId) => {
  // 1. Device bilgilerini topla
  const deviceInfo = {
    model: Device.modelName || 'Unknown',           // expo-device
    os: `${Device.osName} ${Device.osVersion}`,     // expo-device  
    app_version: Application.nativeApplicationVersion, // expo-application
    battery_level: 85,                              // Static (expo-battery gerekli)
    signal_strength: 4                              // Static (native API gerekli)
  };

  // 2. GPS metadata hazƒ±rla
  const gpsMetadata = {
    satellites: 8,                                  // Static (expo-location saƒülamaz)
    hdop: 1.2,                                     // Static
    altitude: location.coords.altitude || 0,       // expo-location
    speed_accuracy: location.coords.speed || 0,    // expo-location
    bearing_accuracy: location.coords.heading || 0  // expo-location
  };

  // 3. KargoMarketing uyumlu JSONB olu≈ütur
  const konum_verisi = {
    device_info: deviceInfo,
    gps_metadata: gpsMetadata,
    timestamp_device: new Date().toISOString(),
    location_source: "GPS",
    collection_method: "automatic"
  };

  // 4. gps_kayitlari tablosuna ekle
  await supabase.from('gps_kayitlari').insert({
    gorev_id: taskId,                              // ‚û°Ô∏è Aktif g√∂rev ID
    sofor_id: userId,                              // ‚û°Ô∏è Giri≈ü yapan ≈üof√∂r ID
    latitude: location.coords.latitude,            // ‚û°Ô∏è expo-location'dan
    longitude: location.coords.longitude,          // ‚û°Ô∏è expo-location'dan
    hiz: location.coords.speed || 0,              // ‚û°Ô∏è expo-location'dan
    yon: location.coords.heading || 0,            // ‚û°Ô∏è expo-location'dan
    dogruluk: location.coords.accuracy || 0,      // ‚û°Ô∏è expo-location'dan
    konum_verisi: konum_verisi                    // ‚û°Ô∏è KargoMarketing metadata
  });
};
```

### üîÑ Trigger ƒ∞≈ülemi (`update_gps_tracking`)

```sql
CREATE OR REPLACE FUNCTION update_gps_tracking()
RETURNS TRIGGER AS $$
BEGIN
  -- 1. gorevler tablosunu g√ºncelle (son konum)
  UPDATE gorevler 
  SET son_konum_lat = NEW.latitude,              -- ‚û°Ô∏è gps_kayitlari'ndan
      son_konum_lng = NEW.longitude,             -- ‚û°Ô∏è gps_kayitlari'ndan
      updated_at = NOW()                         -- ‚û°Ô∏è G√ºncelleme zamanƒ±
  WHERE id = NEW.gorev_id;
  
  -- 2. gps_tracking tablosunu g√ºncelle (KargoMarketing i√ßin)
  INSERT INTO gps_tracking (
    gorev_id, latitude, longitude, hiz, yon, dogruluk, created_at, updated_at
  ) VALUES (
    NEW.gorev_id,                                -- ‚û°Ô∏è gps_kayitlari'ndan
    NEW.latitude,                                -- ‚û°Ô∏è gps_kayitlari'ndan  
    NEW.longitude,                               -- ‚û°Ô∏è gps_kayitlari'ndan
    NEW.hiz,                                     -- ‚û°Ô∏è gps_kayitlari'ndan
    NEW.yon,                                     -- ‚û°Ô∏è gps_kayitlari'ndan
    NEW.dogruluk,                                -- ‚û°Ô∏è gps_kayitlari'ndan
    NEW.timestamp,                               -- ‚û°Ô∏è gps_kayitlari'ndan
    NEW.timestamp                                -- ‚û°Ô∏è gps_kayitlari'ndan
  )
  ON CONFLICT (gorev_id)                         -- üîÑ Aynƒ± g√∂rev varsa g√ºncelle
  DO UPDATE SET
    latitude = EXCLUDED.latitude,                -- ‚û°Ô∏è Yeni koordinat
    longitude = EXCLUDED.longitude,              -- ‚û°Ô∏è Yeni koordinat
    hiz = EXCLUDED.hiz,                          -- ‚û°Ô∏è Yeni hƒ±z
    yon = EXCLUDED.yon,                          -- ‚û°Ô∏è Yeni y√∂n
    dogruluk = EXCLUDED.dogruluk,                -- ‚û°Ô∏è Yeni doƒüruluk
    updated_at = EXCLUDED.updated_at;            -- ‚û°Ô∏è G√ºncelleme zamanƒ±
  
  RETURN NEW;
END;
```

### üéØ Trigger √áalƒ±≈üma Zamanƒ±

```sql
CREATE TRIGGER on_gps_update
  AFTER INSERT ON gps_kayitlari                 -- ‚úÖ gps_kayitlari'na her yeni kayƒ±t
  FOR EACH ROW EXECUTE FUNCTION update_gps_tracking(); -- ‚ö° Otomatik trigger
```

---

## üìã WORKFLOW (Adƒ±m Adƒ±m)

### 1Ô∏è‚É£ **G√∂rev Olu≈üturma** (KargoMarketing)
```
KargoMarketing ‚Üí gorevler tablosu
‚îú‚îÄ‚îÄ ilan_no: "KM2025001"
‚îú‚îÄ‚îÄ tc_kimlik: "12345678901"  
‚îú‚îÄ‚îÄ sofor_adi: "Ahmet Yƒ±lmaz"
‚îú‚îÄ‚îÄ teslimat_adresi: "ƒ∞stanbul Kadƒ±k√∂y..."
‚îî‚îÄ‚îÄ durum: "eslesme_bekleniyor"
```

### 2Ô∏è‚É£ **TC Kimlik E≈üle≈ütirme** (Trigger)
```
Trigger auto_assign_driver()
‚îú‚îÄ‚îÄ profiles tablosunda tc_kimlik ara
‚îú‚îÄ‚îÄ E≈üle≈üme bulunursa:
‚îÇ   ‚îú‚îÄ‚îÄ sofor_id: UUID ata
‚îÇ   ‚îú‚îÄ‚îÄ durum: "atandi" 
‚îÇ   ‚îî‚îÄ‚îÄ sefer_durumu: "atandi"
‚îî‚îÄ‚îÄ E≈üle≈üme yoksa:
    ‚îú‚îÄ‚îÄ durum: "sofor_bulunamadi"
    ‚îî‚îÄ‚îÄ sefer_durumu: "beklemede"
```

### 3Ô∏è‚É£ **≈ûof√∂r Giri≈ü** (Mobile App)
```
Mobile App
‚îú‚îÄ‚îÄ TC kimlik ile e≈üle≈üen g√∂revleri al
‚îú‚îÄ‚îÄ gorevler.sofor_id = session.user.id
‚îî‚îÄ‚îÄ G√∂revleri listele
```

### 4Ô∏è‚É£ **G√∂rev Kabul** (Mobile App)
```
acceptTask() fonksiyonu
‚îú‚îÄ‚îÄ durum: "atandi" g√ºncelle
‚îú‚îÄ‚îÄ kabul_edildi_mi: true g√ºncelle  
‚îî‚îÄ‚îÄ ≈ûof√∂r artƒ±k sefer ba≈ülatabilir
```

### 5Ô∏è‚É£ **Sefer Ba≈ülatma** (Mobile App)
```
startGPSTracking() fonksiyonu
‚îú‚îÄ‚îÄ sefer_durumu: "yolda" g√ºncelle
‚îú‚îÄ‚îÄ baslangic_zamani: timestamp kaydet
‚îú‚îÄ‚îÄ GPS izin al (expo-location)
‚îú‚îÄ‚îÄ ƒ∞lk konum al
‚îî‚îÄ‚îÄ sendGPSData() √ßaƒüƒ±r ‚Üí gps_kayitlari'na kaydet
```

### 6Ô∏è‚É£ **GPS Takip** (Her 10 saniye)
```
setInterval(() => {
  Location.getCurrentPositionAsync() 
  ‚îú‚îÄ‚îÄ Yeni konum al
  ‚îú‚îÄ‚îÄ sendGPSData() √ßaƒüƒ±r  
  ‚îî‚îÄ‚îÄ gps_kayitlari'na kaydet
    ‚îú‚îÄ‚îÄ latitude, longitude, hiz, yon, dogruluk
    ‚îî‚îÄ‚îÄ konum_verisi JSONB (device + GPS metadata)
}, 10000)
```

### 7Ô∏è‚É£ **Otomatik Trigger** (Her GPS kaydƒ±nda)
```
gps_kayitlari INSERT ‚Üí Trigger tetiklenir
‚îú‚îÄ‚îÄ gorevler.son_konum_lat/lng g√ºncelle
‚îî‚îÄ‚îÄ gps_tracking UPSERT (gorev_id bazƒ±nda tek kayƒ±t)
    ‚îú‚îÄ‚îÄ latitude, longitude, hiz, yon, dogruluk
    ‚îî‚îÄ‚îÄ updated_at timestamp
```

### 8Ô∏è‚É£ **KargoMarketing Dashboard**
```
KargoMarketing Dashboard
‚îú‚îÄ‚îÄ gps_tracking tablosunu oku (RLS policy ile)
‚îú‚îÄ‚îÄ gorev_id bazƒ±nda son konum g√∂ster
‚îî‚îÄ‚îÄ Real-time harita √ºzerinde takip
```

### 9Ô∏è‚É£ **Sefer Tamamlama** (Mobile App)
```
stopGPSTracking() fonksiyonu  
‚îú‚îÄ‚îÄ sefer_durumu: "tamamlandi" g√ºncelle
‚îú‚îÄ‚îÄ bitis_zamani: timestamp kaydet
‚îú‚îÄ‚îÄ GPS tracking'i durdur
‚îî‚îÄ‚îÄ Son konum gps_kayitlari'na kaydet
```

---

## üîß √ñNEMLƒ∞ TEKNIK DETAYLAR

### üìä **Tablo ƒ∞li≈ükileri**
- `gorevler` ‚Üê **Master** (Ana g√∂rev bilgileri)
- `gps_kayitlari` ‚Üê **Detay** (T√ºm GPS ge√ßmi≈üi)  
- `gps_tracking` ‚Üê **√ñzet** (Son konum - KargoMarketing i√ßin)

### üöÄ **Performans**
- `gps_tracking` tek kayƒ±t per g√∂rev (UNIQUE constraint)
- `gps_kayitlari` t√ºm ge√ßmi≈ü (b√ºy√ºk tablo)
- KargoMarketing sadece `gps_tracking` okur (hƒ±zlƒ±)

### üîí **G√ºvenlik (RLS)**
- ≈ûof√∂rler sadece kendi GPS'lerini ekleyebilir
- KargoMarketing sadece `gps_tracking` okuyabilir
- Admin t√ºm verilere eri≈üebilir

### üì± **Mobile App K√ºt√ºphaneler**
- `expo-location`: GPS koordinat
- `expo-device`: Device bilgileri  
- `expo-application`: App versiyonu
- `expo-constants`: Device constants

---

## üéØ SONU√á

Bu sistem **3 tablolu** **master-detail** yapƒ±sƒ±yla √ßalƒ±≈üƒ±yor:

1. **`gorevler`** = Ana g√∂rev y√∂netimi (KM + ≈ûof√∂r + GPS)
2. **`gps_kayitlari`** = Ham GPS verileri (Sadece Mobile App)  
3. **`gps_tracking`** = ƒ∞≈ülenmi≈ü GPS √∂zeti (Sadece KargoMarketing Dashboard)

**Veri akƒ±≈üƒ± tamamen otomatik** ve **trigger-based** √ßalƒ±≈üƒ±yor! üöÄ
